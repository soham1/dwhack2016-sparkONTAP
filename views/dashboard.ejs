<% include layout-header %>

<div id="liveData">
  
</div>


<script id="webhook-data-template" type="text/x-handlebars-template">

  {{#each dataList}}
    <div>{{msys.message.message_type}} Received on: {{msys.message.timestampDate}}</div>
  {{/each}}

</script>

<script>
  var dataTemplate = Handlebars.compile($("#webhook-data-template").html());    
  initDashboard();
  

  function initDashboard(){
    initSocket();
  }

  function initSocket(){
    console.log('Initing socket');
    var socket = io.connect();
    socket.on('newFiles', function (data) {
      console.log('newFiles', data);
      renderData(data);
    });
  }
  
  function uinuxTimestampToDate(unix_timestamp){
    var a = new Date(unix_timestamp * 1000);
    return a.toString();
  }
  
  
  function renderData(data){
    var renderData = data.map(function(d){
      var keys = Object.keys(d.msys);
      if(keys.length > 0){
        d.msys.message = {
          message_type: keys[0],
          timestamp: d.msys[keys[0]].timestamp,
          timestampDate: uinuxTimestampToDate(d.msys[keys[0]].timestamp)
        }
      }else{
        console.log('No keys forund under msys');
      }
      return d;
    });
    var html = dataTemplate({dataList: renderData});
    console.log(html);
    $("#liveData").prepend(html);
    
  }

</script>





<% include layout-footer %>